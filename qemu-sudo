#!/bin/sh

: "${cmdline=quiet}"

get_args() {
  for arg; do shift && test "$arg" = "--" && break; done
  if test "$#" = "0"; then
    set -- "${SHELL:-sh}"
  fi
  case "$(printf %s "$PWD" "$@")" in
    *\"*) exit 2 ;;
    *\ *) exit 2 ;;
  esac
  printf "%s\n" "$@"
}

ARGS="$(get_args "$@")"

i=0
for arg; do
  if test "$((i += 1))" = "1"; then set --; fi
  if test "$arg" = "--"; then break; fi
  set -- "$@" "$arg"
done

exec qemu-system-x86_64 \
  -kernel "$(dirname -- "$(realpath -- "$0")")/kernel" -device virtio-rng-pci \
  -serial stdio -display none -vga none \
  -fsdev local,id=root,path=/,security_model=none,multidevs=remap \
  -device virtio-9p-pci,fsdev=root,mount_tag=/dev/root \
  -append "$cmdline rootfstype=9p rootflags=trans=virtio,version=9p2000.L init=/bin/sh -- -c "'"stty -onlcr; mount -t proc proc /proc; IFS=; cd -- $0; $@; busybox poweroff -f"'" $PWD $ARGS" \
  "$@"
